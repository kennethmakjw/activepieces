# Build Stage
FROM node:18.17.1-bullseye AS build

WORKDIR /app

COPY package*.json ./

RUN npm install

COPY . .

RUN npx nx run-many --target=build --projects=backend,ui-core

# Runtime Stage
FROM ubuntu:22.04 AS runtime

RUN apt-get update && apt-get install -y nginx nodejs

# Copy backend build output
COPY --from=build /app/dist/packages/backend/main.js /app/backend/
COPY --from=build /app/dist/packages/backend/package.json /app/backend/

# Copy frontend build output 
COPY --from=build /app/dist/packages/ui/core /var/www/html

# Nginx config
COPY packages/ui/core/nginx.conf /etc/nginx/sites-available/default  

# Set up backend
WORKDIR /app/backend
ENTRYPOINT ["node", "main.js"] 

EXPOSE 80
