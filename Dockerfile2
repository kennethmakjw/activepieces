# Build frontend
FROM activepieces/ap-base:7 AS build-frontend
WORKDIR /app

COPY packages/ui/core/package.json ./ui/core/package.json
RUN npm install

COPY packages/ui/core/src/app/linkedin ./ui/core/src/app/linkedin

COPY packages/ui/core ./ui/core
RUN npm run build

# Build backend 
FROM activepieces/ap-base:7 AS build-backend
WORKDIR /app
COPY packages/backend/package.json ./backend/package.json
RUN npm install --production
COPY packages/backend ./backend 
RUN npm run build

# Final stage
FROM activepieces/ap-base:7
COPY --from=build-frontend /app/dist /usr/share/nginx/html
COPY --from=build-backend /app/dist /usr/share/nginx/backend

# Nginx config
RUN rm /etc/nginx/conf.d/default.conf
COPY packages/ui/core/nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
