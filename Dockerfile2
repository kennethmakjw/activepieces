# Build Stage
FROM node:18.17.1-bullseye AS build

RUN npm install -g @nrwl/cli

WORKDIR /app

COPY package.json ./
RUN npm install

COPY . .

RUN npx nx build backend

# Debug build output location
RUN ls -l /app/dist/packages/backend 

# Runtime Stage 
FROM ubuntu:22.04 AS runtime

RUN apt-get update && apt-get install -y nodejs nginx

# Copy entire /app folder
COPY --from=build /app /usr/src/app

# Debug contents
RUN ls -l /usr/src/app/dist/packages/backend

COPY packages/ui/core/nginx.conf /etc/nginx/nginx.conf
COPY docker-entrypoint.sh /

RUN chmod +x /docker-entrypoint.sh
ENTRYPOINT ["/docker-entrypoint.sh"]

EXPOSE 80
