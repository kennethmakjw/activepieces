### Build Stage ###
FROM node:18.17.1-bullseye AS build

# Copy default.cf
COPY packages/backend/src/assets/default.cf /usr/local/etc/isolate

# Install apt dependencies
RUN apt-get update \
  && apt-get install -y --no-install-recommends locales locales-all libcap-dev \
  && rm -rf /var/lib/apt/lists/*

# Set locale  
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US:en
ENV LC_ALL en_US.UTF-8

# Install global dependencies
RUN npm i -g npm@9.3.1 pnpm@7.28.0 
RUN pnpm store add @tsconfig/node18 @types/node typescript

# Install app dependencies
WORKDIR /app
COPY package.json ./
RUN npm install

# Copy source and build
COPY . .
RUN npx nx run-many --target=build --projects=backend,ui-core

### Runtime Stage ###
FROM ubuntu:22.04 as runtime

RUN apt-get update && apt-get install -y nginx

# Copy artifacts
COPY --from=build /app/dist/packages/backend /usr/src/app/dist/packages/backend  
COPY --from=build /app/dist/packages/ui/core /usr/share/nginx/html

# Nginx config
COPY packages/ui/core/nginx.conf /etc/nginx/nginx.conf  

# Entrypoint
COPY docker-entrypoint.sh /
RUN chmod +x /docker-entrypoint.sh  
ENTRYPOINT ["/docker-entrypoint.sh"]

EXPOSE 80
