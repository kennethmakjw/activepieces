# Build Stage
FROM node:18.17.1-bullseye AS build

# Install dependencies
RUN npm install -g nx

# Clone your repo
RUN git clone https://github.com/kennethmakjw/activepieces.git
WORKDIR /app/activepieces

# Copy and build custom pieces
COPY packages/pieces ./packages/pieces
RUN npx nx build pieces

# Copy source from original image
COPY --from=activepieces/ap-base:7 /app/packages ./packages
COPY --from=activepieces/ap-base:7 /app/libs ./libs 

# Build rest of app
RUN npx nx build backend ui-core

# Runtime Stage
FROM ubuntu:22.04 AS runtime

RUN apt-get update && apt-get install -y nginx

COPY --from=build /app/dist/packages/backend /usr/src/app/dist/packages/backend
COPY --from=build /app/dist/packages/ui/core /usr/share/nginx/html

COPY packages/ui/core/nginx.conf /etc/nginx/nginx.conf

COPY docker-entrypoint.sh /
RUN chmod +x /docker-entrypoint.sh

ENTRYPOINT ["/docker-entrypoint.sh"]  

EXPOSE 80
