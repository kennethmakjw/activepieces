### Build Stage ###
FROM activepieces/ap-base:7 AS build

# Install dependencies
RUN apt-get update && apt-get install -y nodejs npm
RUN npm install -g nx

# Clone repo
RUN git clone https://github.com/kennethmakjw/activepieces.git
WORKDIR /app/activepieces

# Copy Nx config from image 
COPY --from=0 /app/nx.* ./

# Build pieces
COPY packages/pieces ./packages/pieces
RUN npx nx build pieces

# Build rest 
COPY . .
RUN npx nx build backend ui-core

### Runtime Stage ###
FROM activepieces/ap-base:7 AS runtime  

# Install Nginx
RUN apt-get update && apt-get install -y nginx

# Copy artifacts
COPY --from=build /app/dist/ /usr/src/app/dist/
COPY --from=build /app/packages/ /usr/src/app/packages/

# Nginx config
COPY packages/ui/core/nginx.conf /etc/nginx/nginx.conf  

# Copy UI
COPY --from=build /app/dist/packages/ui/core /usr/share/nginx/html

# Entrypoint
COPY docker-entrypoint.sh /
RUN chmod +x /docker-entrypoint.sh
ENTRYPOINT ["/docker-entrypoint.sh"]

EXPOSE 80
