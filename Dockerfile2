### Build Stage ###
FROM ubuntu:22.04 as build

# Install Node.js 18
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
RUN apt-get update && apt-get install -y nodejs

# Install global deps
RUN npm i -g npm@latest pnpm@latest
RUN pnpm store add @tsconfig/node18 @types/node typescript

# Setup locales 
RUN apt-get update && apt-get install -y locales locales-all libcap-dev
RUN rm -rf /var/lib/apt/lists/*
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US:en  
ENV LC_ALL en_US.UTF-8

# Install app dependencies
WORKDIR /app
COPY package.json pnpm-lock.yaml ./
RUN npm ci

# Clone repo and build  
RUN git clone https://github.com/kennethmakjw/activepieces.git
WORKDIR /app/activepieces
COPY packages/backend packages/backend
COPY packages/ui packages/ui
RUN npx nx run-many --target=build --projects=backend,ui-core

### Runtime Stage ###
FROM ubuntu:22.04

RUN apt-get update && apt-get install -y nginx

COPY --from=build /app/activepieces/dist/packages/backend /usr/src/app/dist/packages/backend
COPY --from=build /app/activepieces/dist/packages/ui/core /usr/share/nginx/html

# Nginx config
COPY packages/ui/core/nginx.conf /etc/nginx/nginx.conf

# Entrypoint
COPY docker-entrypoint.sh /
RUN chmod +x /docker-entrypoint.sh
ENTRYPOINT ["/docker-entrypoint.sh"]

EXPOSE 80
