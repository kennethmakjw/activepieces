### Build Stage ###
FROM activepieces/ap-base:7 AS build

# Copy custom pieces code
WORKDIR /app/packages 
COPY ./pieces /app/packages/pieces

# Build pieces
RUN npx nx build pieces

# Copy rest of source
COPY . .

# Build 
RUN npx nx build backend ui-core

### Runtime Stage ###
FROM activepieces/ap-base:7 AS runtime

# Install Nginx
RUN apt-get update && apt-get install -y nginx

# Copy artifacts from build
COPY --from=build /app/dist/ /usr/src/app/dist/
COPY --from=build /app/packages/ /usr/src/app/packages/

# Nginx config
COPY packages/ui/core/nginx.conf /etc/nginx/nginx.conf

# Copy UI files
COPY --from=build /app/dist/packages/ui/core /usr/share/nginx/html

# Entrypoint 
COPY docker-entrypoint.sh /
RUN chmod +x /docker-entrypoint.sh
ENTRYPOINT ["/docker-entrypoint.sh"]

EXPOSE 80
